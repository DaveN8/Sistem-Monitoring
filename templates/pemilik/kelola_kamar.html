{% extends 'base.html' %}

{% block title %}
Kelola Kamar
{% endblock %}

{% block navbar %}
{% include 'navbar_pemilik.html' %}
{% endblock %}

{% block content %}

<div class="p-6">
    <h1 class="text-3xl font-bold mb-6">Kelola Kamar</h1>

    <h3 class="text-xl font-bold mb-6 text-gray-400">Tambah Kamar</h3>

    <!-- Form Tambah Kamar -->
    <form method="POST" action="{{ url_for('kelola_kamar') }}" class="mb-10 space-y-4">
        <div>
            <label class="block font-semibold mb-1">Nomor Kamar</label>
            <input type="text" name="nomor_kamar" required class="w-full border p-2 rounded shadow-sm">
        </div>
        <div>
            <label class="block font-semibold mb-1">Tarif per KWH</label>
            <input type="number" name="tarif_per_kwh" step="0.01" required class="w-full border p-2 rounded shadow-sm"
                placeholder="1444.70">
        </div>
        <div>
            <label class="block font-semibold mb-1">Batas kWh Bulanan</label>
            <input type="number" name="batas_watt" step="0.01" required class="w-full border p-2 rounded shadow-sm"
                placeholder="100.0">
        </div>
        <button class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded font-semibold">Tambah Kamar</button>
    </form>

    <hr class="h-1 bg-gray-300 rounded my-4">
    <br>

    <h3 class="text-xl font-bold mb-6 text-gray-400">Edit Kamar</h3>

    <!-- Daftar Kamar -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">

        {% for k in kamar %}
        <div class="bg-white rounded-lg shadow-md p-4 flex flex-col space-y-4">

            <!-- Info Kamar -->
            <div class="space-y-1 text-sm">
                <p><span class="font-semibold">Nomor:</span> {{ k.NomorKamar }}</p>
                <p><span class="font-semibold">Tarif/kWh:</span> Rp {{ k.TarifPerKWH }}</p>
                <p><span class="font-semibold">Batas kWh:</span> {{ k.BatasKWH or 0 }}</p>

                {% set penghuni = penghuni_list | selectattr("uid", "equalto", k.UserID) | list %}
                <p><span class="font-semibold">Penghuni:</span>
                    {% if penghuni|length > 0 %}
                    {{ penghuni[0].nama }} - {{ penghuni[0].email }}
                    {% else %}
                    - Kosong -
                    {% endif %}
                </p>

                <p><span class="font-semibold">Relay:</span> {{ k.relay_status or 'OFF' }}</p>
            </div>

            <hr>

            <div class="flex flex-col space-y-3">
                <!-- Edit Kamar -->
                <form action="{{ url_for('edit_kamar', id=k.id) }}" method="POST" class="space-y-2">
                    <h3 class="font-semibold text-xs text-gray-600">Nomor Kamar</h3>
                    <input type="text" name="nomor_kamar" value="{{ k.NomorKamar }}"
                        class="w-full border p-2 rounded text-sm" required>
                    <h3 class="font-semibold text-xs text-gray-600">Tarif per kWh Kamar</h3>
                    <input type="number" step="0.1" name="tarif_per_kwh" value="{{ k.TarifPerKWH }}"
                        class="w-full border p-2 rounded text-sm" required>
                    <h3 class="font-semibold text-xs text-gray-600">Batas kWh</h3>
                    <input type="number" step="1.0" name="batas_kwh" value="{{ k.BatasKWH }}"
                        class="w-full border p-2 rounded text-sm" required>
                    <button
                        class="w-full bg-green-600 hover:bg-green-700 text-white py-2 rounded text-sm">Update</button>
                </form>

                <hr>

                <!-- Assign Penghuni -->
                <form action="/pemilik/kamar/assign/{{ k.id }}" method="POST" class="space-y-2">
                    <h3 class="font-semibold text-xs text-gray-600">Assign Penghuni</h3>
                    <select name="user_id" class="w-full border p-2 rounded text-sm">
                        <option value="">Kosongkan</option>
                        {% for u in penghuni_list %}
                        <option value="{{ u.uid }}" {% if u.uid==k.UserID %}selected{% endif %}>
                            {{ u.nama }} - {{ u.email }}
                        </option>
                        {% endfor %}
                    </select>
                    <button
                        class="w-full bg-purple-600 hover:bg-purple-700 text-white py-2 rounded text-sm">Simpan</button>
                </form>

                <hr>

                <!-- Tombol Hapus pakai Modal -->
                <button onclick="openModal('{{ k.id }}')"
                    class="w-full bg-red-600 hover:bg-red-700 text-white py-2 rounded text-sm">
                    Hapus Kamar
                </button>

                <!-- Modal Konfirmasi -->
                <div id="modal-{{ k.id }}"
                    class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white p-6 rounded-lg space-y-4 max-w-xs mx-auto text-center">
                        <h3 class="text-lg font-semibold">Konfirmasi Hapus</h3>
                        <p class="text-sm text-gray-600">Yakin ingin menghapus kamar {{ k.NomorKamar }}?</p>
                        <div class="flex justify-between space-x-2 mt-4">
                            <button onclick="closeModal('{{ k.id }}')"
                                class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 py-2 rounded">Batal</button>
                            <form action="{{ url_for('delete_kamar', id=k.id) }}" method="POST" class="flex-1">
                                <button
                                    class="w-full bg-red-600 hover:bg-red-700 text-white py-2 rounded">Hapus</button>
                            </form>
                        </div>
                    </div>
                </div>
                <!-- End Modal -->

            </div>
        </div>
        {% endfor %}
    </div>
</div>


<script>
    function openModal(id) {
        document.getElementById('modal-' + id).classList.remove('hidden');
    }
    function closeModal(id) {
        document.getElementById('modal-' + id).classList.add('hidden');
    }
</script>
{% endblock %}